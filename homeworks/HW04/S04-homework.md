# Домашнее задание к семинару 04 (HW04)

Тема: HTTP-сервис качества датасетов поверх проекта `eda-cli` (FastAPI + REST API).

HW04 относится к семинару **S04** и выполняется в личном репозитории студента, созданном на основе шаблона `aie-student-template`, в папке `homeworks/HW04/`.  
Проект HW04 опирается на результаты HW03 и переиспользует доработанный `eda-cli` (эвристики качества, параметры отчёта и т.п.).

---

## 1. Цель

Закрепить:

- понимание, как «библиотека + CLI» превращается в **HTTP-сервис**;
- базовые навыки работы с **FastAPI** и запуском сервиса через `uvicorn`;
- умение **проектировать простой REST-контракт**:
  - форматы запросов и ответов;
  - выбор кодов ошибок для типичных ситуаций;
  - включение технических полей (latency, флаги качества) для логирования;
- практику обёртывания уже существующей логики `eda-cli` (эвристики качества данных и EDA) в HTTP-эндпоинты;
- навык добавления **собственного эндпоинта**, завязанного на доработки из HW03.

---

## 2. Задание

### 2.1. Структура для HW04

1. В корне репозитория должна быть папка `homeworks/` (создать, если её ещё нет).
2. Внутри `homeworks/` нужно создать папку `HW04/`.
3. В папке `homeworks/HW04/` должна лежать папка с проектом на базе вашего решения HW03, например:

   ```text
   homeworks/
     HW04/
       eda-cli/
         pyproject.toml
         README.md
         src/
           eda_cli/
             __init__.py
             core.py
             viz.py
             cli.py
             api.py
         tests/
           test_core.py
         data/
           example.csv
   ```

   Допустимо другое имя вложенной папки (например, `mini-eda-cli/`), но:

      - должно быть очевидно, что в `HW04/` лежит **целый проект** (а не отдельные файлы);
      - в проекте обязательно должны быть `pyproject.toml`, каталог `src/` с пакетом `eda_cli`, а также `api.py` с HTTP-сервисом.

4. Основанием для HW04 является **ваш проект HW03**:

   - допускается скопировать содержимое `homeworks/HW03/eda-cli` в `homeworks/HW04/eda-cli` и работать уже с копией;
   - важно, чтобы именно версия в `homeworks/HW04/` соответствовала требованиям HW04.

5. Не нужно копировать в проект:

   - виртуальное окружение `.venv/`;
   - временные каталоги (`.pytest_cache/`, `reports/` и аналогичные);
   - большие исходные датасеты, не относящиеся к заданию.

---

### 2.2. Подготовка проекта

Перед началом разработки HTTP-сервиса убедитесь, что ваш проект из HW03 корректно работает в новой папке HW04.

1. Перейдите в папку с проектом внутри `HW04/`, например:

   ```bash
   cd homeworks/HW04/eda-cli
   ```

2. Установите зависимости через `uv`:

   ```bash
   uv sync
   ```

3. Проверьте, что **CLI** продолжает работать на учебном датасете:

   ```bash
   uv run eda-cli overview data/example.csv
   uv run eda-cli report data/example.csv --out-dir reports_example
   ```

4. Убедитесь, что тесты ядра так же проходят:

   ```bash
   uv run pytest -q
   ```

Если на этом этапе возникают ошибки, сначала восстановите корректную работу проекта HW03 (эвристики, параметры отчёта, тесты), а уже потом переходите к добавлению HTTP-сервиса.

---

### 2.3. Основное задание: HTTP-сервис поверх `eda-cli`

Основная часть HW04 — **инженерная**: вы добавляете HTTP-слой на FastAPI поверх уже существующего `eda-cli`.

#### 2.3.1. Зависимости и модуль `api.py`

1. Убедитесь, что в `pyproject.toml` проекта добавлены зависимости:

   - `fastapi`
   - `uvicorn[standard]`
   - `python-multipart`

   Это можно сделать:

   - либо вручную, отредактировав `[project.dependencies]` в `pyproject.toml`;
   - либо командами:

     ```bash
     uv add fastapi uvicorn[standard] python-multipart
     ```

2. Скопируйте эталонный файл `api.py` из материалов семинара S04 в свой проект HW04:

   - источник: проект семинара `S04/eda-cli`, файл `src/eda_cli/api.py`;
   - назначение: ваш проект в `homeworks/HW04/eda-cli/src/eda_cli/api.py`.

   Разрешается:

   - править только мелкие вещи (опечатки, комментарии, очевидные баги, связанные с вашим кодом ядра);
   - **не переписывать заново** эндпоинты `/health`, `/quality`, `/quality-from-csv`, реализованные на семинаре.

3. После копирования файла `api.py`:

   ```bash
   cd homeworks/HW04/eda-cli
   uv sync
   uv run uvicorn eda_cli.api:app --reload --port 8000
   ```

   Проверьте, что:

      - `GET /health` возвращает `200 OK` и ожидаемый JSON;
      - `POST /quality` и `POST /quality-from-csv` работают так же, как в примере с семинара (через `/docs` или HTTP-клиент).

4. Далее (см. п. **2.3.2**) вам нужно **доработать** этот HTTP-сервис: добавить собственный эндпоинт, завязанный на доработки HW03. Реализовывать с нуля `/health`, `/quality` и `/quality-from-csv` в рамках HW04 не требуется.

---

#### 2.3.2. Собственный эндпоинт, завязанный на HW03 (обязательно)

Каждый студент должен реализовать **минимум один новый HTTP-эндпоинт**, который:

- **не дублирует** уже реализованные в семинарном `api.py` эндпоинты `/health`, `/quality` или `/quality-from-csv`;
- **использует доработки из HW03** (новые эвристики качества, JSON-сводки, дополнительные команды CLI или визуализации).

Вариант по умолчанию (подходит всем):

##### Вариант A (рекомендуется): `POST /quality-flags-from-csv`

1. Эндпоинт:

   ```http
   POST /quality-flags-from-csv
   ```

   - принимает CSV-файл (аналогично `/quality-from-csv`);
   - возвращает **полный набор флагов качества**, включая те, что вы добавили в HW03.

2. Требования:

   - прочитать CSV-файл в DataFrame;
   - вызвать `summarize_dataset`, `missing_table`, `compute_quality_flags`;
   - вернуть JSON вида:

     ```json
     {
       "flags": {
         "too_few_rows": false,
         "too_many_missing": true,
         "has_constant_columns": false,
         "has_high_cardinality_categoricals": true,
         "has_suspicious_id_duplicates": false,
         "has_many_zero_values": true
       }
     }
     ```

     состав словаря зависит от того, какие эвристики вы реализовали в HW03.

3. Важно, чтобы в ответе были **видны ваши новые флаги** из HW03 (например, `has_constant_columns`, `has_high_cardinality_categoricals` и т.п.).

Альтернативные варианты (по желанию, можно выбрать один вместо A):

##### Вариант B. HTTP-версия JSON-сводки

Если в HW03 вы реализовывали опцию JSON-сводки (например, `--json-summary`), можно сделать:

- эндпоинт `POST /summary-from-csv`, который:

  - принимает CSV-файл;
  - строит ту же сводку, что и ваш CLI-режим `--json-summary`;
  - возвращает её в теле HTTP-ответа (`application/json`).

##### Вариант C. HTTP-head / sample

Если в HW03 вы делали CLI-команду `head` или `sample`:

- реализовать HTTP-обёртку:

  ```http
  POST /head
  ```

  или

  ```http
  POST /sample
  ```

  которая принимает CSV + параметр `n` и возвращает первые `n` строк или случайную выборку строк в JSON-формате.

---

### 2.4. Дополнительная часть (опционально, но приветствуется)

Эта часть **не обязательна для зачёта**, но позволяет прокачать инженерную составляющую и улучшить проект. Можно выбрать **любой один** вариант (или придумать свой).

#### Вариант D. Структурированное логирование запросов

- Вместо простых `print` реализовать простое логирование:

  - писать в стандартный вывод или файл `logs/api.log` строки JSON с полями:

    - `endpoint`, `status`, `latency_ms`, `ok_for_model`, `n_rows`, `n_cols`, `timestamp`, `request_id` (uuid);
  - использовать модуль `logging` или явную сериализацию в JSON.

#### Вариант E. Небольшой клиент для сервиса

- Написать простой скрипт (например, `scripts/client.py`), который:

  - отправляет несколько запросов к `/quality` и/или `/quality-from-csv` с разными параметрами/файлами;
  - выводит сводку по ответам (статус, `quality_score`, `latency_ms`).

#### Вариант F. Эндпоинт `/metrics`

- Реализовать эндпоинт `GET /metrics`, который:

  - возвращает простую статистику по работе сервиса (хранить в памяти):

    - `total_requests`, `avg_latency_ms`, `last_ok_for_model` и т.п.

---

## 3. Требования к структуре и именованию

Обязательная структура к дедлайну:

- в корне репозитория: папка `homeworks/`;
- внутри неё: папка `HW04/`;
- внутри `HW04/`: подпапка с проектом `eda-cli` (или аналогичным названием), содержащая:

  - `pyproject.toml`;
  - каталог `src/` с пакетом `eda_cli` и модулем `api.py`;
  - каталог `tests/` с тестами ядра (`test_core.py`);
  - папку `data/` с учебным файлом `example.csv`;
  - актуальный `README.md` с кратким описанием CLI и HTTP-сервиса.

Требования:

- названия папок `homeworks/` и `HW04/` должны быть **строго такими**, как указано (регистр букв важен);

- в проекте не должно быть закоммичено виртуальное окружение `.venv/` и другие временные каталоги;

- проект должен запускаться стандартными командами (из папки проекта внутри `HW04/`):

  ```bash
  cd homeworks/HW04/eda-cli   # или соответствующий путь
  uv sync
  uv run eda-cli report data/example.csv --out-dir reports_example
  uv run uvicorn eda_cli.api:app --reload --port 8000
  ```

- CLI и ядро из HW03 должны по-прежнему работать (отчёт строится, тесты `pytest` проходят);

- HTTP-сервис должен корректно отвечать на `GET /health`, `POST /quality`, `POST /quality-from-csv` и ваш новый эндпоинт.

---

## 4. Критерии зачёта

Домашнее задание считается зачтённым, если к дедлайну:

1. В публичном репозитории студента присутствует папка `homeworks/HW04/` с вложенным проектом `eda-cli` (или эквивалентным).
2. Проект содержит:

   - `pyproject.toml` с зависимостями `fastapi` и `uvicorn[standard]`;
   - каталог `src/eda_cli/` с файлами `core.py`, `viz.py`, `cli.py`, `api.py`;
   - каталог `tests/` с тестами для ядра (или эквивалентным набором тестов);
   - папку `data/` с учебным CSV.
3. Эндпоинт `GET /health`:

   - отвечает кодом `200`;
   - возвращает JSON со статусом сервиса.
4. Эндпоинт `POST /quality`:

   - принимает JSON по схеме `QualityRequest`;
   - возвращает JSON по схеме, совместимой с `QualityResponse` (включая `ok_for_model`, `quality_score`, `latency_ms`, `flags`);
   - логика предсказания зависит от входных параметров.
5. Эндпоинт `POST /quality-from-csv`:

   - принимает CSV-файл;
   - использует EDA-ядро (`summarize_dataset`, `missing_table`, `compute_quality_flags`);
   - возвращает `quality_score` и набор флагов качества, завязанных на вашей реализации HW03;
   - корректно обрабатывает ошибки чтения и пустой CSV (код `400`).
6. Реализован **как минимум один дополнительный эндпоинт**, который:

   - не дублирует `/health`, `/quality`, `/quality-from-csv`;
   - явно использует доработки из HW03 (новые эвристики, JSON-сводки, дополнительные команды и т.п.);
   - корректно описан в README (кратко указано, что он делает и какие параметры принимает).
7. Проект запускается и проверяется командами:

   ```bash
   uv sync
   uv run eda-cli report data/example.csv --out-dir reports_example
   uv run pytest -q
   uv run uvicorn eda_cli.api:app --port 8000
   ```

   и эндпоинты работают согласно описанию.

Дополнительно приветствуется (но не обязательно для зачёта):

- аккуратное оформление `README.md` с примерами запросов к API;
- реализация одного или нескольких вариантов из дополнительной части (логирование, `/metrics`, клиентский скрипт);
- проверка работы сервиса на собственных CSV-файлах помимо `example.csv`.

---

## 5. Сроки и порядок сдачи

- Работа выполняется **индивидуально**.
- Дедлайн выполнения HW04 объявляется преподавателем отдельно (в чате/на портале курса).
- Фактом сдачи работы считается наличие к указанному дедлайну:

  - публичного репозитория студента;
  - структуры `homeworks/HW04/` с вложенным проектом `eda-cli` (или эквивалентным);
  - реализованных HTTP-эндпоинтов (`/health`, `/quality`, `/quality-from-csv` и дополнительного эндпоинта);
  - работоспособности проекта при запуске указанных команд.
- Проверка осуществляется через клонирование репозитория преподавателем и запуск команд `uv run …` и `uv run uvicorn …` внутри проекта.
